apiVersion: v1
kind: ConfigMap
metadata:
  name: mmrelay-config
  namespace: matrix
  labels:
    app: mmrelay
data:
  config.yaml: |
    matrix:
      # MATRIX AUTHENTICATION - Choose ONE method:
      #
      # Method 1 (RECOMMENDED): Use 'mmrelay auth login' command
      # This creates secure credentials.json with E2EE support and persistent device identity.
      # Run: mmrelay auth login
      # Best for: All deployment types (pipx, Docker, Kubernetes)
      # NO CONFIG FIELDS NEEDED - credentials.json provides all authentication data
      #
      # Method 2: Environment Variables (Kubernetes/Docker)
      # Set these environment variables instead of using password in config:
      #   MMRELAY_MATRIX_HOMESERVER=https://matrix.example.org
      #   MMRELAY_MATRIX_BOT_USER_ID=@bot:example.org
      #   MMRELAY_MATRIX_PASSWORD=your_password
      #   MMRELAY_MATRIX_ACCESS_TOKEN=your_access_token  # Optional alternative to password
      # Best for: Kubernetes deployments with secrets, automated CI/CD
      # NO CONFIG FIELDS NEEDED - environment variables provide all authentication data
      #
      # Method 3 (LEGACY): Password in config.yaml (NOT RECOMMENDED)
      # Uncomment the fields below. MMRelay will create credentials.json on first run.
      # IMPORTANT: Remove the password from this file after first successful startup!
      # Security: chmod 600 ~/.mmrelay/config.yaml (Linux/macOS)
      # ONLY USE THIS if you cannot use Method 1 or Method 2
      #homeserver: https://example.matrix.org
      #bot_user_id: "@botuser:example.matrix.org"
      #password: your_matrix_password_here
      #
      # See docs/KUBERNETES.md for Kubernetes-specific authentication setup
      # See docs/E2EE.md for End-to-End Encryption configuration
    
      # End-to-End Encryption (E2EE) configuration
      # E2EE is automatically enabled when using credentials.json (auth login or password/env-based auth)
      # AND E2EE dependencies are installed (Linux/macOS only)
      # NOTE: E2EE is not available on Windows due to dependency limitations
      #
      # SETUP INSTRUCTIONS:
      # 1. Install E2EE dependencies: pipx install 'mmrelay[e2e]' (Linux/macOS only)
      # 2. Authenticate using Method 1 or Method 2 to create credentials.json
      #    (If using the legacy config password, set it above and run once)
      # 3. MMRelay will automatically create credentials.json with E2EE support
      # 4. For interactive setup, use: mmrelay auth login
      #
      e2ee:
        enabled: true
    
      # Message prefix customization (Meshtastic → Matrix direction)
      #prefix_enabled: true # Enable prefixes on messages from mesh (e.g., "[Alice/MyMesh]: message")
      #prefix_format: "[{long}/{mesh}]: " # Default format. Variables: {long1-20}, {long}, {short}, {mesh1-20}, {mesh}
    
    matrix_rooms: # Needs at least 1 room & channel, but supports all Meshtastic channels
      - id: "#someroomalias:example.matrix.org" # Matrix room aliases & IDs supported
        meshtastic_channel: 0
      - id: "!someroomid:example.matrix.org"
        meshtastic_channel: 2
    
    meshtastic:
      connection_type: tcp #Choose either "tcp", "serial", or "ble"
      host: meshtastic.local #Only used when connection is "tcp"
      port: 4403 # Only used when connection is "tcp"
      serial_port: /dev/ttyUSB0 # Only used when connection is "serial"
      ble_address: AA:BB:CC:DD:EE:FF # Only used when connection is "ble" - Uses either an address or name from a `meshtastic --ble-scan`
      meshnet_name: Your Meshnet Name # This is displayed in full on Matrix, but is truncated when sent to a Meshnet
      message_interactions: # Configure reactions and replies (both require message storage in database)
        reactions: false # Enable reaction relaying between platforms
        replies: false   # Enable reply relaying between platforms
    
      # Connection health monitoring configuration
      #health_check:
      #  enabled: true                    # Enable/disable periodic health checks (default: true)
      #  heartbeat_interval: 60           # Interval in seconds between health checks (default: 60)
      #                                   # Note: BLE connections use real-time disconnection detection and skip periodic checks
      #                                   # Legacy: heartbeat_interval at meshtastic level still supported but deprecated
    
      # Additional configuration options (commented out with defaults)
      broadcast_enabled: true # Must be set to true to enable Matrix to Meshtastic messages
      #detection_sensor: true # Must be set to true to forward messages of Meshtastic's detection sensor module
      #message_delay: 2.2 # Delay in seconds between messages sent to mesh (minimum: 2.0 due to firmware)
      #timeout: 30 # Timeout in seconds for Meshtastic operations (default: 30, library default: 300)
    
      # Message prefix customization (Matrix → Meshtastic direction)
      #prefix_enabled: true # Enable username prefixes on messages sent to mesh (e.g., "Alice[M]: message")
      #prefix_format: "{display5}[M]: " # Default format. See ADVANCED_CONFIGURATION.md for all variables.
    
    logging:
      level: info
      #log_to_file: true                          # Set to true to enable file logging
      #filename: ~/.mmrelay/logs/mmrelay.log      # Default location if log_to_file is true
      #max_log_size: 10485760                     # 10 MB default if omitted
      #backup_count: 1                            # Keeps 1 backup as the default if omitted
      #color_enabled: true                        # Set to false to disable colored console output
      #rich_tracebacks: false                     # Show rich tracebacks in console output (defaults to false)
    
      # Component-specific debug logging (useful for troubleshooting)
      # Values: true = DEBUG level, false = suppressed, or specify level: "debug", "info", "warning", "error"
      #debug:
      #  matrix_nio: false      # Suppress matrix-nio logging
      #  bleak: true             # Enable DEBUG level for BLE
      #  meshtastic: "warning"   # Enable warning+ level for meshtastic
    
    #database:
    #  path: ~/.mmrelay/data/meshtastic.sqlite   # Default location
    #  enable_wal: true  # Enable Write-Ahead Logging for better concurrency
    #  busy_timeout_ms: 5000  # Milliseconds to wait if the database is busy
    #  pragmas:
    #    synchronous: NORMAL
    #    temp_store: MEMORY
    #  msg_map: # The message map is necessary for the relay_reactions functionality. If `relay_reactions` is set to false, nothing will be saved to the message map.
    #    msgs_to_keep: 500 # If set to 0, it will not delete any messages; Defaults to 500
    #    wipe_on_restart: true # Clears out the message map when the relay is restarted; Defaults to False
    
    # These are core Plugins - Note: Some plugins are experimental and some need maintenance.
    plugins:
      # Global setting for all plugins: require bot mentions for commands
      #require_bot_mention: true  # Set to false to disable mention requirements for all plugins
      
      ping:
        active: true
        #require_bot_mention: true  # Override global setting for this plugin only
        #channels: [2,3,5] # List of channels the plugin will respond to; DMs are always processed if the plugin is active
      weather:
        active: true
        #require_bot_mention: true  # Override global setting for this plugin only
        units: imperial # Options: metric, imperial - Default is metric
        #channels: [] # Empty list, will only respond to DMs
      nodes:
        active: true
        #require_bot_mention: true  # Override global setting for this plugin only
        # Does not need to specify channels, as it's a Matrix-only plugin
    
    #community-plugins:
    #  sample_plugin:
    #    active: true
    #    repository: https://github.com/username/sample_plugin.git
    #    tag: master
    #  advanced_plugin:
    #    active: false
    #    repository: https://github.com/username/advanced_plugin.git
    #    tag: v1.2.0
    
    #custom-plugins:
    #  my_custom_plugin:
    #    active: true
    #  another_custom_plugin:
    #    active: false
