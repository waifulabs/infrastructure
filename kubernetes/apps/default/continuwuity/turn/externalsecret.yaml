---
# yaml-language-server: $schema=https://kubernetes-schemas.ok8.sh/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: coturn-secret
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: coturn-secret
    template:
      data:
        turnserver.conf: |
          # Listening ports
          listening-port=3478
          alt-listening-port=3479
          tls-listening-port=5349

          # Relay ports range (media streams)
          # ~100 ports = ~50 concurrent calls (2 ports per call)
          min-port=49152
          max-port=49252

          # Authentication
          use-auth-secret
          static-auth-secret={{ .TURN_SECRET }}

          # Realm
          realm=turn.ok8.sh

          # TLS certificates (wildcard *.ok8.sh)
          cert=/tls/tls.crt
          pkey=/tls/tls.key

          # Security: Block access to private networks
          # denied-peer-ip=0.0.0.0-0.255.255.255
          # denied-peer-ip=10.0.0.0-10.255.255.255
          # denied-peer-ip=100.64.0.0-100.127.255.255
          # denied-peer-ip=127.0.0.0-127.255.255.255
          # denied-peer-ip=169.254.0.0-169.254.255.255
          # denied-peer-ip=172.16.0.0-172.31.255.255
          # denied-peer-ip=192.0.0.0-192.0.0.255
          # denied-peer-ip=192.0.2.0-192.0.2.255
          # denied-peer-ip=192.88.99.0-192.88.99.255
          # denied-peer-ip=192.168.0.0-192.168.255.255
          # denied-peer-ip=198.18.0.0-198.19.255.255
          # denied-peer-ip=198.51.100.0-198.51.100.255
          # denied-peer-ip=203.0.113.0-203.0.113.255
          # denied-peer-ip=240.0.0.0-255.255.255.255

          # Resource limits
          user-quota=12
          total-quota=1200
          max-bps=1000000

          # Performance and security
          fingerprint
          no-multicast-peers
          no-cli
          no-loopback-peers
          no-software-attribute
          no-tlsv1
          no-tlsv1_1

          # Logging
          verbose
          log-file=stdout
  dataFrom:
    - extract:
        key: continuwuity
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: ok8-sh-tls
spec:
  refreshPolicy: CreatedOnce
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: ok8-sh-tls
    creationPolicy: Orphan
    template:
      type: kubernetes.io/tls
      metadata:
        annotations:
          cert-manager.io/alt-names: "*.ok8.sh,ok8.sh"
          cert-manager.io/certificate-name: ok8-sh
          cert-manager.io/common-name: ok8.sh
          cert-manager.io/ip-sans: ""
          cert-manager.io/issuer-group: ""
          cert-manager.io/issuer-kind: ClusterIssuer
          cert-manager.io/issuer-name: letsencrypt-production
          cert-manager.io/uri-sans: ""
        labels:
          controller.cert-manager.io/fao: "true"
  dataFrom:
    - extract:
        key: ok8-sh-tls
        decodingStrategy: Base64